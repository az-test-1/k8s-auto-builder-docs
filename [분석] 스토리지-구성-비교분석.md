# 스토리지 구성 비교 분석

> 분석일: 2026-01-08
> 목적: 현재 Azure Files PVC vs Azure Blob Storage 비교

---

## 1. 현재 구성 (AS-IS)

### 1.1 스토리지 설정

```yaml
# StorageClass
provisioner: file.csi.azure.com
parameters:
  skuName: Premium_LRS    # Premium 티어
  protocol: nfs           # NFS 프로토콜 (SMB보다 빠름)
mountOptions:
  - nconnect=4            # 4개 TCP 연결 (성능 최적화)

# PVC
accessModes: ReadWriteMany
storage: 100Gi
storageClassName: azurefile-csi-premium
```

### 1.2 저장 데이터 구조

```
/data/cms/                          # PVC 마운트 포인트 (100Gi)
├── upload/                         # 사용자 업로드 파일
│   └── {project_id}/              # 프로젝트별 소스코드 ZIP
├── projects/                       # 빌드 결과물
│   └── {project_id}/
│       ├── source/                # 압축 해제된 소스
│       ├── build/                 # 빌드 산출물
│       └── logs/                  # 빌드 로그
├── common_lib/                     # 공유 라이브러리 캐시
│   ├── .m2/repository/            # Maven 캐시 (~2-10GB)
│   └── .gradle/                   # Gradle 캐시 (~1-5GB)
├── logs/                          # 애플리케이션 로그
│   ├── app_2026-01-08.log
│   └── app_error_2026-01-08.log
└── settings/                      # 커스텀 설정 파일
```

### 1.3 PVC를 사용하는 컴포넌트

| 컴포넌트 | 마운트 경로 | 용도 | 접근 패턴 |
|----------|-------------|------|-----------|
| cms-web-api | /data/cms | 파일 업로드/다운로드 | Read/Write |
| cms-web-mcp | /data/cms | 프로젝트 파일 접근 | Read |
| cms-celery-worker | /data/cms | 빌드 작업 관리 | Read/Write |
| K8s Job (빌드) | /data/cms | Maven/Gradle 빌드 | Read/Write (집중적) |

### 1.4 현재 구성 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    Azure Files Premium (NFS)                     │
│                         100Gi, Premium_LRS                       │
│                    nconnect=4 (4x TCP 연결)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │ web-api  │   │  worker  │   │ K8s Job  │
        │ /data/cms│   │ /data/cms│   │ /data/cms│
        └──────────┘   └──────────┘   └──────────┘
              │               │               │
              └───────────────┴───────────────┘
                              │
                    모든 Pod가 동일 볼륨 공유
```

---

## 2. 변경 후 구성 (TO-BE) - Azure Blob Storage

### 2.1 변경 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                      Azure Blob Storage                          │
│                    (Hot/Cool/Archive 티어)                       │
│                       무제한 용량                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                        REST API 호출
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │ web-api  │   │  worker  │   │ K8s Job  │
        │ 로컬 /tmp │   │ 로컬 /tmp │   │ 로컬 /tmp │
        │ + Blob   │   │ + Blob   │   │ + emptyDir│
        └──────────┘   └──────────┘   └──────────┘
              │               │               │
        로컬 SSD에서     로컬 SSD에서     로컬 SSD에서
        빠르게 작업      빠르게 작업       빌드 수행
              │               │               │
              └───────────────┴───────────────┘
                              │
                    완료 후 Blob에 업로드

┌─────────────────────────────────────────────────────────────────┐
│  추가 구성: Maven/Gradle 캐시용 PVC (ReadWriteMany 유지)         │
│  - /data/cache (10Gi) - 캐시 전용, 손실되어도 무방               │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 저장 위치 변경

| 데이터 | 현재 (PVC) | 변경 후 | 이유 |
|--------|------------|---------|------|
| **upload/** | /data/cms/upload | Blob: `uploads/` | 대용량 파일, API 업로드 |
| **projects/** | /data/cms/projects | Blob: `projects/` | 빌드 산출물 보관 |
| **logs/** | /data/cms/logs | stdout → Loki/EFK | Cloud Native 로깅 |
| **common_lib/** | /data/cms/common_lib | PVC 유지 (캐시용) | 캐시 공유 필요 |
| **settings/** | /data/cms/settings | ConfigMap/Secret | K8s 네이티브 |

---

## 3. 정량적 비교 분석

### 3.1 성능 비교

#### 3.1.1 IOPS (Input/Output Operations Per Second)

| 항목 | Azure Files Premium | Azure Blob Storage | 차이 |
|------|--------------------:|-------------------:|-----:|
| **최대 IOPS** | 100,000 | 20,000 (단일 Blob) | Files 유리 |
| **실제 사용 IOPS** | ~1,000-5,000 | N/A (API 기반) | - |
| **동시 접근 시** | IOPS 공유 (분산) | 독립적 API 호출 | Blob 유리 |

```
시나리오: Pod 5개가 동시 파일 작업

Azure Files (100Gi Premium):
- 기본 IOPS: 약 3,000 (100GB * 30 IOPS/GB)
- Pod당 IOPS: 3,000 / 5 = 600 IOPS
- 빌드 시 파일 수천개 접근 → 병목 가능

Azure Blob:
- Pod별 독립적 API 호출
- 병렬 처리로 더 빠를 수 있음
```

#### 3.1.2 처리량 (Throughput)

| 항목 | Azure Files Premium (NFS) | Azure Blob | 승자 |
|------|-------------------------:|-----------:|------|
| **최대 처리량** | 300 MiB/s (100GiB 기준) | 60 Gbps (계정당) | Blob |
| **단일 파일 업로드** | ~100 MB/s | ~200 MB/s | Blob |
| **작은 파일 다수** | 느림 (메타데이터 오버헤드) | 느림 (API 오버헤드) | 비슷 |

#### 3.1.3 지연시간 (Latency)

| 작업 | Azure Files (NFS) | Azure Blob | 차이 |
|------|------------------:|----------:|------|
| **파일 열기** | 1-5ms | N/A (API) | Files 유리 |
| **첫 바이트 읽기** | 5-10ms | 10-50ms | Files 유리 |
| **100MB 다운로드** | ~1초 | ~0.5초 | Blob 유리 |
| **메타데이터 조회** | 1-2ms | 5-20ms | Files 유리 |

### 3.2 비용 비교

#### 3.2.1 월간 스토리지 비용 (Korea Central 기준)

| 항목 | Azure Files Premium | Azure Blob (Hot) | 차이 |
|------|--------------------:|-----------------:|-----:|
| **100GB 저장** | $17.50/월 | $2.08/월 | **88% 절감** |
| **500GB 저장** | $87.50/월 | $10.40/월 | **88% 절감** |
| **1TB 저장** | $175.00/월 | $20.80/월 | **88% 절감** |

#### 3.2.2 트랜잭션 비용

| 항목 | Azure Files Premium | Azure Blob (Hot) |
|------|--------------------:|-----------------:|
| **쓰기 (10,000건)** | 포함 | $0.065 |
| **읽기 (10,000건)** | 포함 | $0.0052 |
| **목록 (10,000건)** | 포함 | $0.065 |

#### 3.2.3 예상 월간 총 비용

```
현재 구성 (Azure Files Premium 100Gi):
├── 스토리지: $17.50
├── 트랜잭션: 포함
└── 총 비용: $17.50/월

변경 후 (Blob 50GB + PVC 10GB 캐시용):
├── Blob Storage (Hot): $1.04
├── PVC (Standard): $1.20
├── 트랜잭션 (예상 100만건): $6.50
└── 총 비용: $8.74/월

절감액: $8.76/월 (50% 절감)
```

### 3.3 가용성 비교

| 항목 | Azure Files Premium | Azure Blob (RA-GRS) |
|------|--------------------:|--------------------:|
| **SLA** | 99.9% | 99.99% |
| **연간 다운타임** | ~8.76시간 | ~52분 |
| **지역 복제** | LRS (단일 DC) | GRS (다중 리전) |
| **장애 복구** | 수동 | 자동 Failover |

### 3.4 확장성 비교

| 항목 | Azure Files | Azure Blob |
|------|------------:|-----------:|
| **최대 용량** | 100 TiB (파일공유) | 무제한 |
| **최대 파일 크기** | 4 TiB | 190.7 TiB |
| **용량 증설** | 수동 (PVC 수정) | 자동 |
| **스케일 아웃** | IOPS 공유 | 독립적 |

---

## 4. 시나리오별 성능 예측

### 4.1 시나리오 1: 단일 빌드 작업 (Maven 프로젝트)

```
작업: 100개 의존성 다운로드 + 컴파일 + 패키징

Azure Files (현재):
├── Maven 캐시 확인: 100 파일 × 5ms = 500ms
├── 의존성 다운로드: 50개 × 200ms = 10초 (캐시 미스 시)
├── 컴파일 (I/O): ~30초
├── JAR 패키징: ~5초
└── 총 소요시간: ~46초

Azure Blob + 로컬 캐시:
├── 캐시 다운로드: 1회 (처음만): ~5초
├── 로컬에서 빌드: ~25초 (로컬 SSD)
├── 결과물 업로드: ~2초
└── 총 소요시간: ~32초 (캐시 있을 때)

예상 개선: 30% 빠름 (46초 → 32초)
```

### 4.2 시나리오 2: 동시 빌드 5개

```
Azure Files (현재):
├── IOPS: 3,000 / 5 Pod = 600 IOPS/Pod
├── Pod당 빌드 시간: ~90초 (I/O 경합)
├── 총 완료 시간: ~90초 (병렬)
└── 리소스 효율: 60%

Azure Blob + 로컬:
├── 각 Pod 독립적 작업
├── Pod당 빌드 시간: ~35초
├── 총 완료 시간: ~35초 (병렬)
└── 리소스 효율: 95%

예상 개선: 61% 빠름 (90초 → 35초)
```

### 4.3 시나리오 3: 대용량 파일 업로드 (500MB ZIP)

```
Azure Files (현재):
├── 업로드 속도: ~100 MB/s
├── 소요 시간: ~5초
└── 다른 Pod 영향: 처리량 공유

Azure Blob:
├── 업로드 속도: ~200 MB/s (Block Blob)
├── 소요 시간: ~2.5초
└── 다른 Pod 영향: 없음

예상 개선: 50% 빠름
```

---

## 5. 장단점 종합 비교

### 5.1 점수표

| 평가 항목 | Azure Files (현재) | Azure Blob (변경) | 가중치 |
|----------|:-----------------:|:----------------:|:------:|
| **성능 (단일 Pod)** | 8/10 | 7/10 | 20% |
| **성능 (다중 Pod)** | 5/10 | 9/10 | 25% |
| **비용 효율** | 4/10 | 9/10 | 15% |
| **가용성** | 7/10 | 9/10 | 15% |
| **확장성** | 5/10 | 10/10 | 10% |
| **구현 복잡도** | 9/10 | 4/10 | 10% |
| **운영 편의성** | 8/10 | 6/10 | 5% |
| **가중 평균** | **6.25** | **7.60** | 100% |

### 5.2 현재 구성 유지가 좋은 경우

```
✅ 현재 구성(Azure Files)이 적합한 상황:

1. Pod 수가 적음 (1-3개)
   - 현재: web-api 1, worker 1, mcp 1
   - I/O 경합 거의 없음

2. 빌드 빈도가 낮음
   - 하루 수십 건 이하
   - IOPS 여유 충분

3. 코드 변경 최소화 원함
   - 파일시스템 접근 그대로 유지
   - 개발 리소스 절약

4. Maven/Gradle 캐시 공유 필요
   - 공유 캐시로 빌드 시간 단축
   - Blob으로는 구현 복잡

5. 빠른 출시가 중요
   - 현재 잘 동작하면 유지
   - "If it ain't broke, don't fix it"
```

### 5.3 변경이 좋은 경우

```
✅ Azure Blob으로 변경이 적합한 상황:

1. Pod 수가 많아질 예정 (5개 이상)
   - HPA로 스케일 아웃 활성화
   - I/O 병목 예상

2. 빌드 빈도가 높음
   - 하루 수백 건 이상
   - 동시 빌드 다수

3. 비용 절감 필요
   - 월 50% 비용 절감 가능
   - 스토리지 증가 예상 시 효과 큼

4. 글로벌 서비스 확장
   - 다중 리전 배포
   - CDN 연동 필요

5. 장기 보관 데이터 많음
   - 빌드 결과물 아카이빙
   - Cool/Archive 티어 활용
```

---

## 6. 결론 및 권장사항

### 6.1 현재 상황 평가

```
┌─────────────────────────────────────────────────────────────┐
│                      현재 상황 진단                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  서비스 규모:     소규모 (Pod 각 1개)                        │
│  빌드 빈도:       낮음 (예상)                                │
│  현재 문제:       없음                                       │
│  스케일 계획:     HPA 적용 (1-5개)                          │
│                                                             │
│  결론: 🟢 현재 구성 유지 권장                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 권장 액션

| 우선순위 | 액션 | 시기 |
|----------|------|------|
| **지금** | 현재 구성 유지 | 즉시 |
| **단기** | I/O 모니터링 추가 | P1 작업 시 |
| **중기** | 병목 발생 시 재검토 | 문제 발생 시 |
| **장기** | 로그만 Loki로 분리 | P1 로깅 작업 시 |

### 6.3 모니터링 지표 추가 권장

```yaml
# Prometheus로 수집할 메트릭
- node_filesystem_avail_bytes{mountpoint="/data/cms"}  # 여유 공간
- node_filesystem_size_bytes{mountpoint="/data/cms"}   # 전체 크기
- node_disk_io_time_seconds_total                      # I/O 대기 시간
- node_disk_reads_completed_total                      # 읽기 횟수
- node_disk_writes_completed_total                     # 쓰기 횟수
```

### 6.4 마이그레이션 트리거 조건

```
다음 조건 중 하나라도 해당되면 Blob Storage 마이그레이션 검토:

□ 빌드 작업 I/O 대기 시간 > 30% (prometheus 메트릭)
□ 동시 빌드 수 > 3개 자주 발생
□ PVC 사용량 > 80% (100Gi 중 80Gi)
□ 월 스토리지 비용 > $50
□ Pod 스케일 아웃 빈번 (5개 이상)
```

---

## 7. 최종 요약

```
┌─────────────────────────────────────────────────────────────┐
│                        비교 요약                             │
├──────────────────┬──────────────────┬───────────────────────┤
│ 항목             │ Azure Files      │ Azure Blob            │
│                  │ (현재)           │ (대안)                │
├──────────────────┼──────────────────┼───────────────────────┤
│ 월 비용 (100GB)  │ $17.50           │ $8.74 (50%↓)         │
│ 가용성 SLA       │ 99.9%            │ 99.99%               │
│ 스케일 아웃      │ 제한적           │ 우수                  │
│ 구현 난이도      │ 쉬움 (현재)      │ 어려움 (코드변경)     │
│ 운영 복잡도      │ 낮음             │ 중간                  │
├──────────────────┼──────────────────┼───────────────────────┤
│ 현재 권장        │ ✅ 유지          │ 모니터링 후 검토      │
└──────────────────┴──────────────────┴───────────────────────┘

현재 규모에서는 Azure Files Premium (NFS)이 적합합니다.
스케일이 커지면 그때 재검토하세요.
```
