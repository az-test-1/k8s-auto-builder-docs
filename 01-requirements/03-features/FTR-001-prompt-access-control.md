# FTR-001: 프롬프트 접근 권한 제한 (Prompt Access Control)

> **Status**: Draft
> **Version**: 0.2.0
> **Last Updated**: 2025-01-13
> **Owner**: [담당자]
> **Parent PRD**: [PRD-XXX](../prd/PRD-XXX.md)
> **Prerequisites**: [FTR-002 사전점검 기능](./FTR-002-pre-validation.md) (선행 개발 필요)

---

## 1. 개요

### 1.1 요약
사용자별 프롬프트 접근 권한을 제한하여, 특정 프롬프트에 대해 허가된 사용자만 조회/실행할 수 있도록 하는 기능입니다.

### 1.2 목표
- 프롬프트에 대한 세분화된 접근 제어 구현
- 역할 기반 접근 제어(RBAC) 지원
- 민감한 프롬프트의 무단 접근 방지
- 감사(Audit) 로그를 통한 접근 이력 추적

### 1.3 비목표 (Non-Goals)
- 프롬프트 콘텐츠 자체의 암호화 (별도 기능으로 분리)
- 외부 IdP(Identity Provider) 연동 (1차 범위 외)

---

## 2. 배경

### 2.1 문제 정의
현재 시스템에서는 모든 사용자가 등록된 모든 프롬프트에 접근할 수 있어, 민감한 업무용 프롬프트나 특정 팀 전용 프롬프트가 무분별하게 노출될 수 있습니다.

### 2.2 현재 상태
- 모든 인증된 사용자가 전체 프롬프트 목록 조회 가능
- 프롬프트 실행에 대한 권한 구분 없음
- 접근 이력 추적 불가

### 2.3 제안 솔루션
프롬프트 단위의 접근 권한 설정 기능을 도입하여:
- 프롬프트별 접근 가능 사용자/그룹 지정
- 권한 레벨 정의 (조회/실행/편집/관리)
- 접근 시도에 대한 감사 로그 기록

---

## 3. 상세 요구사항

### 3.1 사용자 스토리

#### US-001: 프롬프트 접근 권한 설정
```
As a 프롬프트 관리자
I want to 특정 프롬프트에 접근할 수 있는 사용자/그룹을 지정
So that 민감한 프롬프트를 허가된 사용자만 사용할 수 있다
```

**인수 조건:**
- [ ] 프롬프트 상세 화면에서 접근 권한 설정 가능
- [ ] 개별 사용자 또는 그룹 단위로 권한 부여 가능
- [ ] 권한 레벨(조회/실행/편집/관리) 선택 가능

#### US-002: 권한에 따른 프롬프트 목록 필터링
```
As a 일반 사용자
I want to 내가 접근 가능한 프롬프트만 목록에서 조회
So that 불필요한 프롬프트가 노출되지 않는다
```

**인수 조건:**
- [ ] 프롬프트 목록 API에서 권한 필터링 적용
- [ ] 권한 없는 프롬프트는 목록에서 제외
- [ ] 접근 불가 프롬프트 직접 조회 시 403 응답

#### US-003: 접근 이력 조회
```
As a 시스템 관리자
I want to 프롬프트별 접근 이력을 조회
So that 보안 감사 및 사용 현황을 파악할 수 있다
```

**인수 조건:**
- [ ] 프롬프트별 접근 로그 조회 기능
- [ ] 조회/실행/수정 이벤트별 필터링
- [ ] 기간별 검색 지원

### 3.2 기능 명세

#### 3.2.1 권한 레벨 정의
| 권한 레벨 | 설명 |
|----------|------|
| VIEW | 프롬프트 조회만 가능 |
| EXECUTE | 프롬프트 조회 및 실행 가능 |
| EDIT | 프롬프트 조회/실행/수정 가능 |
| ADMIN | 모든 권한 + 접근 권한 관리 |

#### 3.2.2 접근 권한 설정 API
| 항목 | 설명 |
|------|------|
| 입력 | promptId, targetId (user/group), targetType, permissionLevel |
| 처리 | 권한 검증 후 접근 권한 테이블에 저장 |
| 출력 | 설정된 권한 정보 |

#### 3.2.3 권한 검증 Flow
| 항목 | 설명 |
|------|------|
| 입력 | userId, promptId, requiredPermission |
| 처리 | 사용자 직접 권한 → 그룹 권한 → 기본 권한 순으로 검증 |
| 출력 | boolean (허용/거부) |

---

## 3.3 사용자 전환 시나리오 (일반 사용자 직접 접근)

### 3.3.1 역할 정의

| 역할 | 권한 범위 | 설명 |
|------|----------|------|
| **운영자 (Admin)** | 전체 | 서비스/프로젝트 등록, 프롬프트 관리, 계정 생성, 모든 설정 변경 |
| **일반 사용자 (User)** | 제한적 | 할당된 서비스의 프로젝트만 조회, 실행 및 결과 리포트 확인만 가능 |

### 3.3.2 사전점검 기능 (Pre-validation)

소스 품질 검증을 통해 기준 미달 소스를 사전에 차단합니다.

| 검증 항목 | 설명 | 실패 시 처리 |
|----------|------|-------------|
| 인코딩 체크 | UTF-8 등 표준 인코딩 여부 확인 | Reject + 수정 가이드 제공 |
| 빌드 가능 여부 | 기본 빌드 성공 여부 확인 | Reject + 에러 로그 제공 |
| 프로젝트 구조 | Maven/Gradle 구조 확인 | Reject + 구조 가이드 제공 |

**기대 효과:**
- 소스 확인 및 커뮤니케이션 비용 절감
- 기준 미달 소스 조기 차단으로 작업 효율 향상

### 3.3.3 서비스/프로젝트 등록 제한

```
As a 일반 사용자
I want to 서비스/프로젝트 등록 없이 할당된 작업만 수행
So that 불필요한 설정 변경 없이 작업에 집중할 수 있다
```

| 기능 | 운영자 | 일반 사용자 |
|------|--------|------------|
| 서비스 등록 | O | X |
| 프로젝트(레포) 등록 | O | X |
| 프롬프트 조회 | O | X (지정된 것만) |
| 프롬프트 수정 | O | X |
| 실행 | O | O (지정된 패턴만) |
| 결과 리포트 조회 | O | O (본인 작업만) |

**서비스-프로젝트 관계:**
- 1개 서비스 : N개 레포(프로젝트)
- 운영자가 서비스 등록 후 사용자에게 할당

### 3.3.4 소스 업로드 제한

| 제약 사항 | 설명 |
|----------|------|
| 사전 확인 통과 필수 | 사전점검 통과한 소스만 업로드 가능 |
| 업로드 후 변경 불가 | 한번 업로드된 소스는 수정 불가 (재업로드 필요) |
| 허용된 소스만 작업 | 승인된 소스에 대해서만 작업 수행 가능 |

### 3.3.5 서비스별 계정 관리

```
As a 운영자
I want to 서비스별로 계정을 생성하고 접근 범위를 지정
So that 사용자가 담당 서비스만 접근할 수 있다
```

**계정 생성 Flow:**
```
[운영자] 서비스 등록 → 계정 생성 → ID/PW 발급 → 사용자에게 전달
```

**접근 제한:**
- 자기가 담당하는 서비스의 프로젝트(레포 단위)만 조회 가능
- 타 서비스/프로젝트는 목록에서 미노출

### 3.3.6 스텝/설정 고정 (Preset Pattern)

일반 사용자는 사전 정의된 패턴만 실행 가능합니다.

#### 패턴(Case) 정의
| 패턴명 | 스텝 구성 | 프롬프트 조합 | 설명 |
|--------|----------|--------------|------|
| Pattern-A | Step1 → Step2 → Step3 | Prompt-001, 002 | 표준 마이그레이션 |
| Pattern-B | Step1 → Step4 | Prompt-003 | 간소화 마이그레이션 |
| Pattern-C | Step5 → Step2 → Step6 | Prompt-004, 005 | 커스텀 (운영자 승인 필요) |

#### 실행 제한 정책
| 상황 | 처리 |
|------|------|
| 지정된 패턴 실행 | 허용 |
| 패턴 외 실행 요청 | 불가 → 운영자 에스컬레이션 |
| 설정값 변경 시도 | 불가 (읽기 전용) |

#### 가설 기반 패턴 예시
> **가설**: pom.xml 먼저 수정 후 프롬프트 실행 시 성공률 향상

| 패턴명 | 스텝 순서 | 예상 성공률 |
|--------|----------|------------|
| POM-First | pom.xml 수정 → 코드 변환 → 검증 | 높음 |
| Code-First | 코드 변환 → pom.xml 수정 → 검증 | 낮음 |

### 3.3.7 에스컬레이션 Flow

```
[일반 사용자] 패턴 외 작업 필요
       ↓
[시스템] 직접 수행 불가 안내
       ↓
[에스컬레이션 요청] 운영자에게 요청 전달
       ↓
[운영자] 검토 후 승인/반려
       ↓
[승인 시] 운영자가 직접 수행 또는 임시 권한 부여
```

---

## 4. UI/UX (선택)

### 4.1 와이어프레임
[추후 추가]

### 4.2 사용자 플로우
```
[프롬프트 목록] → [프롬프트 상세] → [권한 설정 탭] → [사용자/그룹 추가] → [권한 레벨 선택] → [저장]
```

---

## 5. 기술 고려사항

### 5.1 의존성
- 사용자 인증/인가 모듈
- 그룹 관리 모듈
- 감사 로그 시스템

### 5.2 제약사항
- 기존 프롬프트의 하위 호환성 유지 (기본값: 전체 공개)
- 권한 검증 성능 최적화 필요 (캐싱 고려)

### 5.3 마이그레이션 (해당시)
- 기존 프롬프트에 기본 접근 권한 정책 적용 필요
- 점진적 마이그레이션 전략 수립

---

## 6. 테스트 계획

| 테스트 유형 | 범위 | 담당 |
|------------|------|------|
| Unit Test | 권한 검증 로직, API 핸들러 | Dev |
| Integration Test | 권한 설정/검증 전체 플로우 | Dev |
| E2E Test | 사용자 시나리오 기반 접근 테스트 | QA |

---

## 7. 릴리즈 계획

### 7.1 마일스톤
| 단계 | 내용 | 목표일 |
|------|------|--------|
| Design | 상세 설계 완료 | TBD |
| Dev | 개발 완료 | TBD |
| QA | 테스트 완료 | TBD |
| Release | 배포 | TBD |

### 7.2 Feature Flag
- Flag Name: `feature_prompt_access_control_enabled`
- 점진적 롤아웃: 10% → 50% → 100%

---

## 8. 성공 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 권한 설정 적용률 | 신규 프롬프트 50% 이상 | 권한 설정된 프롬프트 비율 |
| 무단 접근 차단율 | 100% | 권한 없는 접근 시도 차단 건수 |
| 권한 검증 응답시간 | < 50ms | API 응답 시간 모니터링 |

---

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 0.1.0 | 2025-01-13 | - | 초기 작성 |
| 0.2.0 | 2025-01-13 | - | 사용자 전환 시나리오 추가 (사전점검, 권한 제한, 패턴 고정) |
